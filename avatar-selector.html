<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./styles.css">
    <title>Selecciona tu Avatar</title>
</head>
<body>
    <header>
        <img src="./images/Logo Pista Musical.webp" alt="Logo Pista Musical">
    </header>
    <h1 class="main_text">Selecciona tu Avatar</h1>
    <div class="avatar-grid" id="avatarGrid"></div>
    <div id="mensaje-estado" style="margin-top: 20px; text-align: center; display: none;">
        Conectando...
    </div>
    
    <script>
        let ws;
        let intentosReconexion = 0;
        const maxIntentosReconexion = 5;
        let reconexionTimeout = null;
        
        const playerId = new URLSearchParams(window.location.search).get('id');
        const salaActual = localStorage.getItem("salaActual");
        const nombreJugador = localStorage.getItem("nombreJugador");
        
        // Mostrar avatares
        const avatars = ["2D.webp", "Adrian Barilari.webp", "Alcides.webp", 
        "Alejandro Lerner.webp", "Alfredo Casero.webp", "Amy Lee.webp", 
        "Amy Winehouse.webp", "Antonio Rios.webp", "Axel Roses.webp", 
        "Bob Marley.webp", "Britney Spears.webp", "Cacho Casta√±a.webp", 
        "Celine Dion.webp", "Chano.webp", "Charly Garcia.webp", 
        "Chester Bennington.webp", "Christina Aguilera.webp", "Conejito Alejandro.webp",
        "Cristian Castro.webp", "Diego Torres.webp", "Dread Mar I.webp",
        "Dyango.webp", "El Polaco.webp", "Elvis Presley.webp", "Emily Armstrong.webp",
        "Fito Paez.webp", "Freddie Mercury.webp", "Gene Simmons.webp", 
        "George Michael.webp", "Gilda.webp", "Gustavo Ceratti.webp",
        "Indio Solari.webp", "James Hetfield.webp", "John Lennon.webp",
        "Ke Personales.webp", "La Mona Jimenez.webp", "Lali.webp",
        "Leo Mattioli.webp", "Limp Bizkit.webp", "Luis Miguel.webp",
        "Madonna.webp", "Maria Becerra.webp", "Michael Jackson.webp",
        "Mick Jagger.webp", "Mike Shinoda.webp", "Miranda.webp", 
        "Natalia Oreiro.webp", "Palito Ortega.webp", "Pelado Cordera.webp",
        "Pimpinela.webp", "Pity Alvarez.webp", "Pocho La Pantera.webp",
        "Ricardo Arjona.webp", "Ricardo Montaner.webp", "Rick Astley.webp",
        "Ricky Maravilla.webp", "Sandro.webp", "Sergio Denis.webp", 
        "Taylor Swift.webp", "Tini.webp"];
        
        const avatarGrid = document.getElementById("avatarGrid");
        avatars.forEach(avatar => {
            let img = document.createElement("img");
            img.src = "./images/avatars/" + avatar;
            img.classList.add("avatar");
            img.onclick = () => seleccionarAvatar(avatar);
            avatarGrid.appendChild(img);
        });

        // Funci√≥n para seleccionar avatar
        function seleccionarAvatar(avatar) {
            // M√©todo 1: Usando conexi√≥n WebSocket si est√° disponible
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    tipo: "seleccionar-avatar",
                    id: playerId,
                    avatar: avatar
                }));
                console.log("Enviado avatar por WebSocket:", avatar);
            }
            
            // M√©todo 2: Siempre usar el endpoint HTTP como respaldo
            fetch("https://broadleaf-darkened-fall.glitch.me/seleccionar-avatar", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id: playerId, avatar: avatar })
            })
            .then(response => response.json())
            .then(data => console.log("Respuesta del servidor:", data))
            .catch(err => console.error("Error enviando avatar:", err));
        }
        
        // Establecer conexi√≥n WebSocket al cargar la p√°gina
        function conectarWebSocket() {
            if (!salaActual || !nombreJugador || !playerId) {
                console.error("‚ùå Falta informaci√≥n de sesi√≥n. No se puede reconectar.");
                return;
            }
            
            document.getElementById("mensaje-estado").style.display = "block";
            document.getElementById("mensaje-estado").textContent = "Reconectando...";
            
            if (ws) {
                ws.close();
            }
            
            ws = new WebSocket("wss://servidor-canciones.onrender.com");
            
            ws.onopen = () => {
                console.log("‚úÖ Conectado al servidor WebSocket desde selecci√≥n de avatar.");
                intentosReconexion = 0;
                let mensaje = JSON.stringify({ 
                    tipo: "unir", 
                    sala: salaActual, 
                    nombre: nombreJugador 
                });
                console.log("üì§ Enviando:", mensaje);
                ws.send(mensaje);
                document.getElementById("mensaje-estado").style.display = "none";
            };
            
            ws.onmessage = (event) => {
                console.log("üì© Mensaje recibido:", event.data);
                try {
                    let respuesta = JSON.parse(event.data);
                    if (respuesta.tipo === "confirmacion-union") {
                        console.log(`üîó Reconectado con ID: ${respuesta.id}`);
                    }
                    else if (respuesta.tipo === "error") {
                        document.getElementById("mensaje-estado").textContent = `Error: ${respuesta.mensaje}`;
                        document.getElementById("mensaje-estado").style.display = "block";
                    }
                    else if (respuesta.tipo === "ping") {
                        // Responder al ping para mantener la conexi√≥n activa
                        console.log("üîÑ Ping recibido");
                    }
                } catch (error) {
                    console.error("‚ùå Error procesando mensaje WebSocket:", error);
                }
            };
            
            ws.onerror = (event) => {
                console.error("‚ùå Error en WebSocket:", event);
                document.getElementById("mensaje-estado").textContent = "Error de conexi√≥n. Intentando reconectar...";
                document.getElementById("mensaje-estado").style.display = "block";
            };
            
            ws.onclose = (event) => {
                console.warn(`‚ö†Ô∏è Conexi√≥n WebSocket cerrada. C√≥digo: ${event.code}, Raz√≥n: ${event.reason}`);
                
                // Intentar reconectar si no fue un cierre intencional
                if (intentosReconexion < maxIntentosReconexion) {
                    intentosReconexion++;
                    document.getElementById("mensaje-estado").textContent = 
                        `Conexi√≥n perdida. Reconectando (${intentosReconexion}/${maxIntentosReconexion})...`;
                    document.getElementById("mensaje-estado").style.display = "block";
                    
                    // Evitar m√∫ltiples timeouts
                    if (reconexionTimeout) {
                        clearTimeout(reconexionTimeout);
                    }
                    
                    reconexionTimeout = setTimeout(() => {
                        conectarWebSocket();
                    }, 3000);
                } else {
                    document.getElementById("mensaje-estado").textContent = 
                        "No se pudo conectar despu√©s de varios intentos.";
                    document.getElementById("mensaje-estado").style.display = "block";
                }
            };
        }
        
        // Iniciar la conexi√≥n al cargar la p√°gina
        window.addEventListener("load", conectarWebSocket);
    </script>
</body>
</html>
