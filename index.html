<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./styles.css">
    <title>La Pista Musical</title>
</head>
<body>
    <header>
        <img src="./images/Logo Pista Musical.webp" alt="Logo Pista Musical">
    </header>

    <!-- Secci√≥n de ingreso a la sala -->
    <section id="joinSection" style="display: block;">
        <h1 class="main_text">Unirse a una Sala</h1>
        <div class="column_holder">
            <div class="texto_and_input1">
                <label for="codigo">C√≥digo de Sala:</label>
                <input type="text" id="codigo" placeholder="" maxlength="4" autocapitalize="characters">
            </div>
            <div class="texto_and_input2">
                <label for="nombre">Tu Nombre:</label>
                <input type="text" id="nombre" placeholder="" maxlength="12">
            </div>
        </div>
        <div class="boton_unirse">
            <button onclick="unirse()">Unirse</button>
        </div>
    </section>

    <!-- Secci√≥n de selecci√≥n de avatar -->
<section id="avatarSection" style="display: none;">
    <h1 class="main_text">Selecciona tu Avatar</h1>
    <div class="avatar-grid" id="avatarGrid">
    </div>
    <div class="btnListo">
        <button id="btnListo" onclick="confirmarAvatar()" disabled>Listo</button>
    </div>
</section>

<!-- Secci√≥n para el primer jugador (host) -->
<section id="hostSection" style="display: none;">
    <h1 class="capo_text">Sos el capo, inicia la partida cuando hayan ingresado los demas</h1>
    <div class="btnComenzar">
        <button id="btnComenzar" onclick="comenzarPartida()">¬°Estamos Todos Listos!</button>
    </div>
</section>

<!-- Secci√≥n para jugadores no host -->
<section id="waitingSection" style="display: none;">
    <h1 class="capo_text" id="waitingMessage"></h1>
</section>

 <!-- Secci√≥n de pulsador e inputs -->
 <section id="juegoSection" style="display: none;">
    <div class="input-container">
        <input id="inputTitulo" type="text" placeholder="T√≠tulo de la canci√≥n" disabled>
        <input id="inputArtista" type="text" placeholder="Nombre del artista" disabled>
    </div>
    <div class="pulsador-container">
        <img id="pulsador" src="./images/Pulsador Idle.webp" alt="Pulsador" onclick="manejarPulsador()">
    </div>
</section>

    <script>
        let ws;
        let estadoPulsador = "inoperable"; // "inoperable", "operable", "pulsado"

        document.getElementById("codigo").addEventListener("input", function () {
            this.value = this.value.toUpperCase();
        });

        function unirse() {
            const sala = document.getElementById("codigo").value.trim();
            const nombre = document.getElementById("nombre").value.trim() || "An√≥nimo";

            if (!sala) {
                alert("Por favor, ingresa un c√≥digo de sala.");
                return;
            }

            ws = new WebSocket("wss://servidor-canciones.onrender.com");

            ws.onopen = () => {
                console.log("‚úÖ Conectado al servidor WebSocket.");
                const mensaje = JSON.stringify({ tipo: "unir", sala, nombre });
                console.log("üì§ Enviando:", mensaje);
                ws.send(mensaje);
            };

            ws.onmessage = (event) => { // Recibe mensajes del servidor
                console.log("üì© Mensaje recibido:", event.data);
                try {
                    const respuesta = JSON.parse(event.data);

                    if (respuesta.tipo === "confirmacion-union") {
                        const playerId = respuesta.id;

                        console.log("üîó Uni√≥n exitosa. Cambiando a selecci√≥n de avatar.");
                        sessionStorage.setItem("playerId", playerId);
                        sessionStorage.setItem("sala", sala);
                        sessionStorage.setItem("playerName", nombre);

                        // Ocultar la secci√≥n de ingreso y mostrar la de selecci√≥n de avatar
                        document.getElementById("joinSection").style.display = "none";
                        document.getElementById("avatarSection").style.display = "block";

                        cargarAvatares();
                    }
                    
                    if (respuesta.tipo === "error-jugadores-no-listos") {
                        alert("Algunos jugadores a√∫n no est√°n listos. No se puede comenzar la partida.");
                    }

                    if (respuesta.tipo === "partida-iniciada") {
                        console.log("üéÆ La partida ha comenzado!");
                        mostrarJuego();
                    }

                    if (respuesta.tipo === "activar_pulsadores") {
                        console.log("üö® Activando pulsadores!");
                        setEstadoPulsador("Ready");
                        // Vibraci√≥n corta
                    if (estadoPulsador != "Ready" && navigator.vibrate) {
                        navigator.vibrate(100); // 100 milisegundos
                        }
                    }

                    if (respuesta.tipo === "desactivar_pulsador") {
                        console.log("‚õî Otro jugador ya puls√≥. Desactivando pulsador.");
                        setEstadoPulsador("Idle");
                    }

                    if (respuesta.tipo === "activar-input-artista") {
                        // Desactivar inputTitulo
                        const inputTitulo = document.getElementById("inputTitulo");
                        inputTitulo.disabled = true;
                        inputTitulo.blur(); // por si ten√≠a el foco

                        // Activar inputArtista
                        const inputArtista = document.getElementById("inputArtista");
                        inputArtista.disabled = false;
                        inputArtista.focus(); // dar foco autom√°ticamente
                    }

                } catch (error) {
                    console.error("‚ùå Error procesando mensaje WebSocket:", error);
                }
            };

            ws.onerror = (event) => {
                console.error("‚ùå Error en WebSocket:", event);
            };

            ws.onclose = () => {
                console.warn("‚ö†Ô∏è Conexi√≥n WebSocket cerrada.");
            };
        }

        function cargarAvatares() {
            const avatars = ["2D.webp", "Adrian Barilari.webp", "Alcides.webp", 
        "Alejandro Lerner.webp", "Alfredo Casero.webp", "Amy Lee.webp", 
        "Amy Winehouse.webp", "Antonio Rios.webp", "Axel Roses.webp", 
        "Bob Marley.webp", "Britney Spears.webp", "Cacho Casta√±a.webp", 
        "Celine Dion.webp", "Chano.webp", "Charly Garcia.webp", 
        "Chester Bennington.webp", "Christina Aguilera.webp", "Conejito Alejandro.webp",
        "Cristian Castro.webp", "Diego Torres.webp", "Dread Mar I.webp",
        "Dyango.webp", "El Polaco.webp", "Elvis Presley.webp", "Emily Armstrong.webp",
        "Fito Paez.webp", "Freddie Mercury.webp", "Gene Simmons.webp", 
        "George Michael.webp", "Gilda.webp", "Gustavo Ceratti.webp",
        "Indio Solari.webp", "James Hetfield.webp", "John Lennon.webp",
        "Ke Personales.webp", "La Mona Jimenez.webp", "Lali.webp",
        "Leo Mattioli.webp", "Limp Bizkit.webp", "Luis Miguel.webp",
        "Madonna.webp", "Maria Becerra.webp", "Michael Jackson.webp",
        "Mick Jagger.webp", "Mike Shinoda.webp", "Miranda.webp", 
        "Natalia Oreiro.webp", "Palito Ortega.webp", "Pelado Cordera.webp",
        "Pimpinela.webp", "Pity Alvarez.webp", "Pocho La Pantera.webp",
        "Ricardo Arjona.webp", "Ricardo Montaner.webp", "Rick Astley.webp",
        "Ricky Maravilla.webp", "Sandro.webp", "Sergio Denis.webp", 
        "Taylor Swift.webp", "Tini.webp"];

            const avatarGrid = document.getElementById("avatarGrid");
            avatarGrid.innerHTML = ""; // Limpiar contenido previo

            avatars.forEach(avatar => {
                const img = document.createElement("img");
                img.src = "./images/avatars/" + avatar;
                img.classList.add("avatar");
                img.onclick = () => seleccionarAvatar(avatar);
                avatarGrid.appendChild(img);
            });
        }

        function confirmarAvatar() {
    const avatar = sessionStorage.getItem("avatar");
    if (!avatar) {
        alert("Debes seleccionar un avatar antes de continuar.");
        return;
    }

    const playerId = parseInt(sessionStorage.getItem("playerId"), 10);
    const sala = sessionStorage.getItem("sala");


    // üîπ Enviar estado READY al servidor
    const mensajeReady = JSON.stringify({
        tipo: "ready",
        sala: sala,
        id: playerId
    });

    console.log("üì§ Enviando estado READY al servidor:", mensajeReady);
    ws.send(mensajeReady);

    if (playerId === 0) {
        // Es el host
        mostrarSeccionHost();
    } else {
        // No es el host
        obtenerNombreHost(sala);
    }
}

// Obtener el nombre del host (playerId 0) desde el servidor
function obtenerNombreHost(sala) {
    fetch(`https://servidor-canciones.onrender.com/obtener-host?sala=${sala}`)
        .then(response => response.json())
        .then(data => {
            if (data && data.nombreHost) {
                mostrarSeccionEspera(data.nombreHost);
            } else {
                console.error("No se pudo obtener el nombre del host.");
            }
        })
        .catch(err => console.error("Error obteniendo el nombre del host:", err));
}


// Habilitar el bot√≥n "Listo" al seleccionar un avatar
function seleccionarAvatar(avatar) {
    const btnListo = document.getElementById("btnListo");

    // Actualizar visualmente el avatar seleccionado
    const avatars = document.querySelectorAll(".avatar");
    avatars.forEach(img => img.classList.remove("avatar-seleccionado"));
    const avatarSeleccionado = Array.from(avatars).find(img => {
        const imgName = decodeURIComponent(img.src.split('/').pop());
        return imgName === avatar;
    });
    if (avatarSeleccionado) avatarSeleccionado.classList.add("avatar-seleccionado");

    // Almacenar el avatar seleccionado
    sessionStorage.setItem("avatar", avatar);
    btnListo.disabled = false;

    // Enviar selecci√≥n de avatar al servidor
    const playerId = sessionStorage.getItem("playerId");
    fetch("https://servidor-canciones.onrender.com/seleccionar-avatar", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: playerId, avatar })
    }).then(response => response.json())
      .then(data => console.log("Avatar seleccionado con √©xito:", data))
      .catch(err => console.error("Error seleccionando avatar:", err));
}

// Mostrar la secci√≥n del host
function mostrarSeccionHost() {
    document.getElementById("avatarSection").style.display = "none";
    document.getElementById("hostSection").style.display = "block";
}

// Mostrar la secci√≥n de espera
function mostrarSeccionEspera(hostName) {
    document.getElementById("avatarSection").style.display = "none";
    document.getElementById("waitingSection").style.display = "block";
    document.getElementById("waitingMessage").innerText =
        `Esperando a que el m√°s capito ${hostName}, inicie la partida.`;
}

// Comenzar la partida (solo para el host)
function comenzarPartida() {
    const sala = sessionStorage.getItem("sala");

ws.send(JSON.stringify({
    tipo: "comenzar-partida",
    sala: sala
}));

console.log("üì§ Enviado mensaje 'comenzar-partida' al servidor.");
}

function mostrarJuego() {
            document.getElementById("hostSection").style.display = "none";
            document.getElementById("waitingSection").style.display = "none";
            document.getElementById("juegoSection").style.display = "block";

            // Empieza el pulsador en Idle
            setEstadoPulsador("Idle");
        }

        function setEstadoPulsador(estado) {
            const pulsador = document.getElementById("pulsador");
            estadoPulsador = estado;

            if (estado === "Idle") {
                pulsador.src = "./images/Pulsador Idle.webp";
                pulsador.style.pointerEvents = "none";
            } else if (estado === "Ready") {
                pulsador.src = "./images/Pulsador Ready.webp";
                pulsador.style.pointerEvents = "auto";
            } else if (estado === "Apretado") {
                pulsador.src = "./images/Pulsador Apretado.webp";
                pulsador.style.pointerEvents = "none";
            }
        }

        function manejarPulsador() {
            
            if (estadoPulsador !== "Ready") return;
            setEstadoPulsador("Apretado");

            // Habilitar input del t√≠tulo
            document.getElementById("inputTitulo").disabled = false;

            // Enviar mensaje al servidor que el jugador puls√≥ (si quer√©s)
            ws.send(JSON.stringify({
                tipo: "pulsador_presionado",
                id: parseInt(sessionStorage.getItem("playerId")),
                sala: sessionStorage.getItem("sala")
            }));
        }

    // Enviar el texto del inputTitulo al servidor en tiempo real
    document.getElementById("inputTitulo").addEventListener("input", function () {
    const texto = this.value;
    const playerId = parseInt(sessionStorage.getItem("playerId"), 10);
    const sala = sessionStorage.getItem("sala");

    if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
            tipo: "titulo-actualizado",
            sala: sala,
            id: playerId,
            titulo: texto
        }));
    }
    //Enviar respuesta al pulsar enter (titulo)
    document.getElementById("inputTitulo").addEventListener("keydown", function (event) {
    if (event.key === "Enter") {
        const playerId = parseInt(sessionStorage.getItem("playerId"), 10);
        const sala = sessionStorage.getItem("sala");

        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({
                tipo: "submit-titulo",
                sala: sala,
                id: playerId
            }));
        }
        event.preventDefault();
    }
    });
    // Enviar el texto del inputArtista al servidor en tiempo real
    document.getElementById("inputArtista").addEventListener("input", function () {
    const texto = this.value;
    const playerId = parseInt(sessionStorage.getItem("playerId"), 10);
    const sala = sessionStorage.getItem("sala");

    if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
            tipo: "artista-actualizado",
            sala: sala,
            id: playerId,
            texto: texto
        }));
    }
    });
    //Enviar respuesta al pulsar enter (artista)
    document.getElementById("inputArtista").addEventListener("keydown", function (event) {
    if (event.key === "Enter") {
        const playerId = parseInt(sessionStorage.getItem("playerId"), 10);
        const sala = sessionStorage.getItem("sala");

        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({
                tipo: "submit-artista",
                sala: sala,
                id: playerId
            }));
        }
        event.preventDefault();
    }
    });

});

    </script>
</body>
</html>