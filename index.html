<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./styles.css">
    <title>La Pista Musical</title>
</head>
<body>
    <header>
        <img src="./images/Logo Pista Musical.webp" alt="Logo Pista Musical">
    </header>
    <h1 class="main_text">Unirse a una Sala</h1>
    
<div class="column_holder">
    <div class="texto_and_input1">
        <label for="codigo">C√≥digo de Sala:</label>
        <input type="text" id="codigo" placeholder="" maxlength="4" autocapitalize="characters">
    </div>
    <div class="texto_and_input2">
        <label for="nombre">Tu Nombre:</label>
        <input type="text" id="nombre" placeholder="" maxlength="12">
    </div>
</div>
    <div class="boton_unirse">
        <button onclick="unirse()" id="btnUnirse">Unirse</button>
    </div>
    <div id="mensaje-estado" style="margin-top: 20px; text-align: center; display: none;">
        Conectando...
    </div>
    <script>
    let ws;
    let intentosReconexion = 0;
    const maxIntentosReconexion = 5;
    let reconexionTimeout = null;
    
    document.getElementById("codigo").addEventListener("input", function () {
        this.value = this.value.toUpperCase();
    });
    
    function unirse() {
        let sala = document.getElementById("codigo").value.trim();
        let nombre = document.getElementById("nombre").value.trim() || "An√≥nimo";
        if (!sala) {
            alert("Por favor, ingresa un c√≥digo de sala.");
            return;
        }
        
        document.getElementById("btnUnirse").disabled = true;
        document.getElementById("mensaje-estado").style.display = "block";
        document.getElementById("mensaje-estado").textContent = "Conectando...";
        
        conectarWebSocket(sala, nombre);
    }
    
   function conectarWebSocket(sala, nombre) {
    if (ws) {
        console.log("üî¥ Cerrando WebSocket anterior antes de conectar uno nuevo.");
        ws.close();
    }
    
    ws = new WebSocket("https://broadleaf-darkened-fall.glitch.me");

    ws.onopen = () => {
        console.log("‚úÖ WebSocket abierto. Enviando datos de uni√≥n...");
        let mensaje = JSON.stringify({ tipo: "unir", sala, nombre });
        console.log("üì§ Enviando:", mensaje);
        ws.send(mensaje);
    };
        
        ws.onmessage = (event) => {
             console.log("üì© Mensaje recibido:", event.data);
            try {
                let respuesta = JSON.parse(event.data);
                if (respuesta.tipo === "confirmacion-union") {
                    let playerId = respuesta.id;
                    let reconectado = respuesta.reconectado || false;
                    
                    console.log(`üîó ${reconectado ? 'Reconectado' : 'Conectado'} con ID: ${playerId}`);
                    
                    // Guardar informaci√≥n en localStorage para potenciales reconexiones
                    localStorage.setItem("salaActual", sala);
                    localStorage.setItem("nombreJugador", nombre);
                    localStorage.setItem("playerId", playerId);
                    
                    // Redirigir a la p√°gina de selecci√≥n de avatar
                    window.location.href = `avatar-selector.html?id=${playerId}`;
                }
                else if (respuesta.tipo === "error") {
                    document.getElementById("mensaje-estado").textContent = `Error: ${respuesta.mensaje}`;
                    document.getElementById("btnUnirse").disabled = false;
                }
                else if (respuesta.tipo === "ping") {
                    // Responder al ping para mantener la conexi√≥n activa
                    console.log("üîÑ Ping recibido");
                }
            } catch (error) {
                console.error("‚ùå Error procesando mensaje WebSocket:", error);
            }
        };
        
        ws.onerror = (event) => {
             console.error("‚ùå Error en WebSocket:", event);
            document.getElementById("mensaje-estado").textContent = "Error de conexi√≥n. Intentando reconectar...";
        };
        
        ws.onclose = (event) => {
             console.warn(`‚ö†Ô∏è WebSocket cerrado. C√≥digo: ${event.code}, Raz√≥n: ${event.reason}`);
            
            // Intentar reconectar si no fue un cierre intencional
            if (intentosReconexion < maxIntentosReconexion) {
                intentosReconexion++;
                document.getElementById("mensaje-estado").textContent = 
                    `Conexi√≥n perdida. Reconectando (${intentosReconexion}/${maxIntentosReconexion})...`;
                
                // Evitar m√∫ltiples timeouts
                if (reconexionTimeout) {
                    clearTimeout(reconexionTimeout);
                }
                
                reconexionTimeout = setTimeout(() => {
                    conectarWebSocket(sala, nombre);
                }, 3000);
            } else {
                document.getElementById("mensaje-estado").textContent = 
                    "No se pudo conectar despu√©s de varios intentos. Por favor, intenta de nuevo.";
                document.getElementById("btnUnirse").disabled = false;
            }
        };
    }
    
    // Verificar si tenemos una sesi√≥n guardada e intentar reconectar autom√°ticamente
    window.addEventListener("load", function() {
        const salaGuardada = localStorage.getItem("salaActual");
        const nombreGuardado = localStorage.getItem("nombreJugador");
        
        if (salaGuardada && nombreGuardado) {
            document.getElementById("codigo").value = salaGuardada;
            document.getElementById("nombre").value = nombreGuardado;
            
            // Opcionalmente, reconectar autom√°ticamente
            // unirse();
        }
    });
</script>
</body>
</html>
